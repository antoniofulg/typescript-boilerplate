# Docker Environment - Full-Stack Boilerplate

This directory contains the complete Docker configuration for the development and production environment of the full-stack boilerplate.

## Structure

```
docker/
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ Dockerfile          # Backend NestJS build
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ Dockerfile          # Frontend Next.js build
â”œâ”€â”€ docker-compose.yml      # Orchestration of all services
â”œâ”€â”€ env.example             # Docker Compose env example
â”œâ”€â”€ env.postgres.example    # PostgreSQL env example
â”œâ”€â”€ env.backend.example     # Backend env example
â”œâ”€â”€ env.frontend.example    # Frontend env example
â”œâ”€â”€ .env                    # Docker Compose config (generated by make setup-env)
â”œâ”€â”€ .env.postgres           # PostgreSQL config (generated by make setup-env)
â”œâ”€â”€ .env.backend            # Backend config (generated by make setup-env)
â””â”€â”€ .env.frontend           # Frontend config (generated by make setup-env)
```

## Services

- **postgres**: PostgreSQL database (port 5432)
- **redis**: Cache and Pub/Sub (port 6379)
- **backend**: NestJS API (port 4000)
- **frontend**: Next.js application (port 3000)

## Prerequisites

- Docker Engine 20.10+
- Docker Compose 2.0+

## How to use

### 1. Setup environment variables

Generate all `.env` files with default values:

```bash
# At project root
make setup-env
```

Or manually copy the example files:

```bash
cd docker
cp env.example .env
cp env.postgres.example .env.postgres
cp env.backend.example .env.backend
cp env.frontend.example .env.frontend
```

**Important for multiple clones:** If you have multiple clones of this repository on the same machine, edit `docker/.env` and set a unique `COMPOSE_PROJECT_NAME`:

```bash
COMPOSE_PROJECT_NAME=my-project-1
POSTGRES_PORT=5432
BACKEND_PORT=4000
FRONTEND_PORT=3000
```

For production, change passwords and secrets in the generated `.env` files.

### 2. Start the environment

**Option A: With Make (recommended)**

```bash
# At project root
make up
```

This command will:

- Start all services
- Wait for services to start
- Automatically display access URLs

**Option B: Manual**

```bash
cd docker
docker-compose up -d

# Then, to see URLs (at project root):
make urls
```

### 3. View service URLs

After starting services, you can view access URLs:

```bash
# At project root
make urls
```

This will display:

- ğŸŒ Frontend: http://localhost:3000
- ğŸŒ Backend API: http://localhost:4000
- ğŸ¥ Healthcheck: http://localhost:4000/health
- ğŸ—„ï¸ PostgreSQL: localhost:5432
- ğŸ’¾ Redis: localhost:6379

### 4. View logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend
docker-compose logs -f frontend
```

### 5. Stop the environment

```bash
docker-compose down
```

### 6. Stop and remove volumes (clean data)

```bash
docker-compose down -v
```

## Prisma Migrations

Prisma migrations are automatically executed when the backend container starts for the first time. To run manually:

```bash
# Enter backend container
docker-compose exec backend sh

# Execute migrations
npm run prisma:migrate:deploy

# Or create new migration
npm run prisma:migrate
```

## Access

After starting services, run `make urls` (at project root) to see all URLs:

- **Frontend**: http://localhost:3000
- **Backend API**: http://localhost:4000
- **Backend Healthcheck**: http://localhost:4000/health
- **PostgreSQL**: localhost:5432
- **Redis**: localhost:6379

## Rebuilding images

If there are code changes, rebuild is necessary:

```bash
# Rebuild all services
docker-compose build

# Rebuild specific service
docker-compose build backend
docker-compose build frontend

# Rebuild and start
docker-compose up -d --build
```

## Troubleshooting

### Backend not connecting to database

Check if PostgreSQL is healthy:

```bash
docker-compose ps
```

Wait for PostgreSQL healthcheck to complete before backend starts.

### Permission error

If there are permission errors, check logs:

```bash
docker-compose logs backend
```

### Clean everything and start over

```bash
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d
```

## Development

For local development without Docker, use the normal project commands:

```bash
# Backend
cd ../backend
npm install
npm run prisma:generate
npm run start:dev

# Frontend
cd ../frontend
npm install
npm run dev
```
